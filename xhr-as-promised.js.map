{"version":3,"file":"xhr-as-promised.js","sources":["../src/index.js"],"sourcesContent":["/* global XMLHttpRequest, ActiveXObject, window, global */\n\nfunction XHR() {\n  if (window.XMLHttpRequest) return new XMLHttpRequest();\n  try { return new ActiveXObject('msxml2.xmlhttp.6.0'); } catch (e) {}\n  try { return new ActiveXObject('msxml2.xmlhttp.3.0'); } catch (e) {}\n  try { return new ActiveXObject('msxml2.xmlhttp'); } catch (e) {}\n}\n\nfunction contains(array, value) {\n  var i = array.length;\n  while (i--) if (array[i] === value) return true;\n  return false;\n}\n\nvar okStatus = [200, 304, 0];\nfunction requestOk(req) { return contains(okStatus, req.status); }\n\nclass XHRError extends Error {\n  constructor(message, status, request) {\n    this.message = message;\n    this.status = status;\n    this.request = request;\n    this.responseHeaders = request.responseHeaders;\n  }\n}\n\nfunction callbacks(name, req, targets) {\n  for (var i = 0; i < targets.length; i++) {\n    if (typeof targets[i][name] === 'function') targets[i][name](req);\n  }\n}\n\nfunction merge() {\n  var res = {}, arg, k;\n  for (var i = 0; i < arguments.length; i++) {\n    arg = arguments[i];\n    if (typeof arg === 'object') {\n      for (k in arg) {\n        res[k] = arg[k];\n      }\n    }\n  }\n  return res;\n}\n\nvar betweenQueryAndHash = /\\?[^#]*#/;\nvar afterQuery = /\\?.*/;\n\nexport default function build(opts) {\n  var Promise = opts.promise || opts.Promise || (window || {}).Promise || (global || {}).Promise;\n\n  if (!Promise) throw new Error('I really need a Promise');\n\n  function xhr(options = {}) {\n    var req = XHR();\n\n    options.headers = options.headers || {};\n\n    if (options.binary && !req.sendAsBinary) return Promise.reject(new Error('This browser does not support binary XHRs.'));\n\n    callbacks('onbegin', req, [opts, options]);\n\n    if (typeof options === 'string') options = { url: options };\n\n    if (options.query && typeof options.query === 'object') {\n      let qs = '';\n      for (let k in options.query) {\n        let v = options.query[k];\n        if (typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean') {\n          qs += (qs ? '&' : '') + `${encodeURIComponent(k)}=${encodeURIComponent(v)}`;\n        }\n      }\n\n      let hash = options.url.indexOf('#') !== -1,\n          query = options.url.indexOf('?') !== -1;\n\n      if (hash && query) {\n        options.url = options.url.replace(betweenQueryAndHash, `?${qs}#`);\n      } else if (hash) {\n        options.url = options.url.replace('#', `?${qs}#`);\n      } else if (query) {\n        options.url = options.url.replace(afterQuery, `?${qs}`);\n      } else {\n        options.url += `?${qs}`;\n      }\n    }\n\n    req.open(options.method || 'GET', options.url, true);\n    if (options.credentials) req.withCredentials = true;\n\n    for (let k in options.headers) req.setRequestHeader(k, options.headers[k]);\n    if (options.method === 'POST' && (!('Content-Type' in options.headers) && !('type' in options))) {\n      req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n    } else if ('type' in options) {\n      req.setRequestHeader('Content-Type', options.type);\n    }\n\n    if ('responseType' in options) req.responseType = options.responseType;\n\n    var res = new Promise((ok, fail) => {\n      req.onreadystatechange = () => {\n        if (req.readyState !== 4) return;\n\n        callbacks('onend', req, [opts, options]);\n\n        if (requestOk(req)) {\n          ok(req);\n        } else {\n          let res = req.responseHeaders = {};\n          if (typeof req.getAllResponseHeaders === 'function') {\n            let headers = req.getAllResponseHeaders().split('\\n');\n            for (let i = 0; i < headers.length; i++) {\n              let n = headers[i].substr(0, headers[i].indexOf(':'));\n              if (!n) continue;\n              let v = headers[i].substr(n.length + 1);\n              res[n] = v;\n              res[n.toLowerCase()] = v;\n            }\n          }\n          fail(new XHRError('Server responded with a status of ' + req.status, req.status, req));\n        }\n      };\n    });\n\n    req[options.binary ? 'sendAsBinary' : 'send'](options.data || void 0);\n\n    return res;\n  }\n\n  (function() {\n    xhr.get = function get(url, opts) { return xhr(merge({ url }, opts)); };\n    xhr.post = function post(url, data, opts) { return xhr(merge({ method: 'POST', url, data }, opts)); };\n    xhr.put = function put(url, data, opts) { return xhr(merge({ method: 'PUT', url, data }, opts)); };\n    xhr['delete'] = xhr.del = function del(url, data, opts) { return xhr(merge({ method: 'DELETE', url, data }, opts)); };\n  })();\n\n  (function() {\n    var json = xhr.json = function json(options = {}) {\n      if (typeof options === 'string') options = { url: options };\n      var headers = options.headers = options.headers || {};\n      if (!('Accept' in headers)) headers.Accept = 'application/json,*/*';\n      if (!('Content-Type' in headers) && !('type' in options)) headers['Content-Type'] = 'application/json';\n      if (typeof options.data !== 'string') options.data = JSON.stringify(options.data || '');\n      return xhr(options).then(res => {\n        if ((res.getResponseHeader('Content-Type') || '').toLowerCase().indexOf('json') !== -1) {\n          return JSON.parse(res.responseText);\n        } else return res;\n      });\n    };\n    json.get = function get(url, opts) { return json(merge({ url }, opts)); };\n    json.post = function post(url, data, opts) { return json(merge({ method: 'POST', url, data }, opts)); };\n    json.put = function put(url, data, opts) { return json(merge({ method: 'PUT', url, data }, opts)); };\n    json['delete'] = json.del = function del(url, data, opts) { return json(merge({ method: 'DELETE', url, data }, opts)); };\n  })();\n\n  return xhr;\n}\n"],"names":[],"mappings":"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"}